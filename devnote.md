# 📅 推しスケ（Oshi-Sche）開発ノート

> VTuber配信スケジュール画像を自動解析してGoogleカレンダーに登録するシステム

**🔗 リポジトリ**: [YoyogiPinball/oshi-sche](https://github.com/YoyogiPinball/oshi-sche.git)
**📅 最終更新**: 2026-01-02
**📦 バージョン**: v2.x (Gemini 2.5 Flash対応版)

---

## 📑 目次

- [プロジェクト概要](#プロジェクト概要)
- [アーキテクチャ](#アーキテクチャ)
- [実装済み機能](#実装済み機能)
- [開発環境セットアップ](#開発環境セットアップ)
- [技術的な課題](#技術的な課題)
- [今後の展望](#今後の展望)
- [トラブルシューティング](#トラブルシューティング)

---

## プロジェクト概要 🎯

### 目的
好きなVTuberが多くて配信スケジュールを追うのが大変な推し活ユーザー向けに、画像をアップロードするだけで自動的にスケジュールを管理できるシステムを提供。

### 主な機能
- 📸 配信スケジュール画像の自動解析（Gemini 2.5 Flash）
- 📊 Googleスプレッドシート自動書き込み
- 📅 Googleカレンダー自動登録（重複チェック付き）
- 💬 Discord毎朝通知（時刻グループ化、時間帯絵文字）

### 技術スタック

| 技術 | 用途 |
|------|------|
| Google Apps Script | メインロジック |
| Gemini 2.5 Flash API | 画像解析エンジン |
| Google Drive API | ファイル管理 |
| Google Sheets API | データ保存 |
| Google Calendar API | 予定登録 |
| Discord Webhook | 通知配信 |
| clasp | GitHub ⇄ GAS 同期 |

---

## アーキテクチャ 🏗️

### 動作フロー

```
📁 Googleドライブに画像アップロード
    ↓
⏰ GASトリガー起動（15分ごと）
    ↓
🤖 Gemini 2.5 Flash で画像解析
    ↓
📊 スプレッドシート書き込み
    ├─ 全データ保管用「スケジュール」シート
    └─ VTuber別シート（今週分のみ表示）
    ↓
📅 Googleカレンダー登録（重複チェック）
    ↓
💬 Discord通知（毎朝6時）
    ↓
📦 処理済みフォルダへ移動
```

### ディレクトリ構成

```
oshi-sche/
├── src/
│   ├── code.gs           # メインコード（48KB、1293行）
│   ├── test.gs           # ユニットテスト
│   ├── testData.gs       # テストデータ
│   └── appsscript.json   # GAS設定
├── docs/
│   ├── oshi-sche-handover.md      # 引き継ぎドキュメント
│   └── vtuber-emoji-reference.md  # VTuber絵文字リファレンス
├── Archive/
│   └── migration-guide.md  # v1→v2移行ガイド
├── README.md
├── LICENSE (MIT)
└── package.json
```

---

## 実装済み機能 ✅

### コア機能

#### 🤖 Gemini 2.5 Flash API連携
- ✅ 画像解析→JSON抽出
- ✅ リトライ機能（最大3回、待機: 1秒→2秒→3秒）
- ✅ エラーコード別対応（400/401/403/429/500/503）
- ✅ API無料枠超過時の自動リトライ
- ✅ 年またぎロジック（12月→1月など）

#### 📊 スプレッドシート管理
- ✅ 全データ保管用「スケジュール」シート
- ✅ VTuber別シート自動生成（今週分のみ表示）
- ✅ 自動クリーンアップ（古いデータ削除）

#### 📅 Googleカレンダー連携
- ✅ 予定の自動登録（開始時刻から1時間枠で登録、カレンダー画面を圧迫しないようにするため）
- ✅ 重複チェック機能
- ✅ イベント詳細（配信URL、備考）

#### 💬 Discord通知
- ✅ 毎朝指定時刻に配信スケジュール一覧を送信
- ✅ 時刻グループ化（深夜・朝・昼・夕方・夜）
- ✅ 時間帯絵文字（🌌🌅☀️🌆🌙）
- ✅ スマホ向け表示最適化

---

### 開発・運用機能

#### 🔧 ドライランモード（細分化対応）
- ✅ `shouldExecute()` 関数で一元管理
- ✅ スプレッドシート、カレンダー、Discord、ファイル移動を個別制御可能
- ✅ 処理ごとの実行判定とサマリー表示

#### 🧪 テスト環境対応
- ✅ TEST_MODE フラグで本番・テスト環境を切り替え
- ✅ テスト用リソースID設定

#### 🔍 フォルダ名パース改善
- ✅ 複数の区切り文字サポート（「：」「:」「/」「-」「｜」など）
- ✅ 長音「ー」、ハイフン「-」、中黒「・」をVTuber名として保護
- ✅ 柔軟な形式認識

#### 🔗 clasp連携
- ✅ GitHub ⇄ GAS の直接同期
- ✅ 手動コピペ不要
- ✅ ローカル開発環境でのコード編集

#### ✅ ユニットテスト
- ✅ test.gs でコード品質を自動検証
- ✅ 7つのテスト関数
- ✅ `runAllTests()` で一括実行

---

## 開発環境セットアップ 🛠️

### 前提条件
- Node.js インストール済み
- Google アカウント
- clasp インストール済み（`npm install -g @google/clasp`）

### セットアップ手順

#### 1. リポジトリクローン

```bash
git clone https://github.com/YoyogiPinball/oshi-sche.git
cd oshi-sche
```

#### 2. clasp ログイン

```bash
clasp login
```

#### 3. GASプロジェクト作成

```bash
clasp create --type standalone --title "推しスケ"
```

#### 4. スクリプトプロパティ設定

GAS編集画面で「プロジェクトの設定」→「スクリプトプロパティ」から必須項目を設定：

| プロパティ名 | 説明 | 必須 |
|-------------|------|------|
| `GEMINI_API_KEY` | Gemini APIキー | ✅ |
| `INPUT_FOLDER_ID` | 入力フォルダID | ✅ |
| `DONE_FOLDER_ID` | 処理済みフォルダID | ✅ |
| `SPREADSHEET_ID` | スプレッドシートID | ✅ |
| `CALENDAR_ID` | カレンダーID | ✅ |
| `SHEET_NAME` | シート名 | ⚪ |
| `DISCORD_WEBHOOK_URL` | Discord Webhook URL | ⚪ |
| `DRY_RUN` | ドライランモード | ⚪ |
| `TEST_MODE` | テスト環境モード | ⚪ |

#### 5. コードをプッシュ

```bash
clasp push
```

#### 6. トリガー設定

- **時間ベーストリガー**: `processNewImages` を15分ごとに実行
- **時間ベーストリガー**: `sendDailyScheduleToDiscord` を毎日午前6時に実行

---

## 技術的な課題 ⚠️

### 🟡 中優先度

#### Gemini API の無料枠制限
- **制限**: 1500リクエスト/日
- **対策**: リトライ機能、エラーハンドリング
- **将来**: 有料プラン検討

#### 年またぎスケジュールの誤判定
- **問題**: 12月末に1月の予定を解析すると年がズレる可能性
- **対策**: 現在の実装で一定の対応済み
- **改善案**: さらに精度向上

#### 複数配信が同日にある場合の扱い
- **現状**: すべて登録される
- **課題**: 重複チェックの精度向上

---

## 今後の展望 🚀

### 未実装機能

- [ ] **WebUIの提供**
  - ブラウザから直接操作できるUI
  - 設定画面、プレビュー機能

- [ ] **スマートフォンアプリ化**
  - iOS/Android対応
  - プッシュ通知

- [ ] **Webアプリ化**
  - スタンドアロンWebアプリ
  - PWA対応

- [ ] **他の用途への応用**
  - シフト表読み取り
  - イベントスケジュール管理

---

## トラブルシューティング 🔧

### よくあるエラー

#### API呼び出し失敗

**エラー**: `Error 429: Too Many Requests`
- **原因**: Gemini API無料枠超過
- **対策**: 24時間待機、または有料プラン契約

#### 画像解析失敗

**エラー**: JSON抽出失敗
- **原因**: 画像の解像度・圧縮率が低い
- **対策**: 高解像度の画像を使用、リトライ

#### フォルダ名パースエラー

**エラー**: VTuber名が正しく認識されない
- **原因**: 区切り文字の誤認識
- **対策**: フォルダ名を「所属：VTuber名」形式に統一

---

## 📚 参考資料

- [README.md](../README.md) - ユーザー向けセットアップガイド
- [oshi-sche-handover.md](./docs/oshi-sche-handover.md) - 引き継ぎドキュメント
- [Gemini API ドキュメント](https://ai.google.dev/)
- [Google Apps Script リファレンス](https://developers.google.com/apps-script)
- [clasp ドキュメント](https://github.com/google/clasp)

---

**💡 TIP**: 困った時は README.md の「よくある質問」セクションを確認してください。

**🎯 次のステップ**: Gemini APIキーを取得して、テスト環境で動作確認を行いましょう。

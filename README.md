# 推しスケ（Oshi-Sche）

> 好きが多いほど忙しい人へ
> 推しの配信予定を逃さないためのスケジュール確認ツール

[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](https://opensource.org/licenses/MIT)

## 🎯 機能概要

VTuberの配信スケジュール画像をGoogleドライブにアップロードするだけで**Gemini AI**が自動で解析し、
Googleスプレッドシート＆Googleカレンダーに登録してくれるシステムです。

推しが多くて配信スケジュールを追うのだけでも一苦労な方へ

---

## ✨ 主な機能

- 📸 **画像から自動解析**: Gemini 2.5 Flash APIで配信スケジュール画像を解析
- 📊 **スプレッドシート管理**: Googleスプレッドシートに自動書き込み
  - 全データ保管用シート: 全スケジュールを時系列で保存
  - VTuber別シート: 推しごとに今週分のみ表示
- 📅 **カレンダー連携**: Googleカレンダーに予定を自動登録
- 💬 **Discord通知**: 毎朝6時に今日・明日のスケジュールを自動配信
- 🤖 **完全自動化**: Google Apps Scriptで定期実行
- 🔄 **重複防止**: 既に処理済みの画像は自動スキップ
- 👥 **複数VTuber対応**: フォルダ分けで複数のVTuberを管理可能
- 🧪 **ドライランモード**: 安全にテスト実行できる機能付き
- 🛡️ **エラーハンドリング**: リトライ機能とエラーコード別対応
---

## 📝 更新履歴

### 2025年12月版

#### 開発インフラの整備（最新）
- **clasp連携**: GitHub ⇄ GAS の直接同期が可能に（手動コピペ不要）
- **テスト環境**: TEST_MODE フラグで本番とテスト環境を切り替え可能
- **ユニットテスト**: test.gs でコードの品質を自動検証
- **GitHub Actions**: PR時に自動で構文チェック・コード検証
- **統一dry-run管理**: `shouldExecute()` 関数で一元管理、コードがシンプルに

#### ドライランモードの細分化
- **処理別制御**: スプレッドシート、カレンダー、Discord、ファイル移動を個別に制御
- **柔軟なテスト**: 例えばDiscord通知だけドライランにすることが可能
- **未設定時の挙動**: 個別フラグ未設定時は `DRY_RUN` の値を自動適用
- **4つの個別フラグ**: `DRY_RUN_SPREADSHEET`, `DRY_RUN_CALENDAR`, `DRY_RUN_DISCORD`, `DRY_RUN_FILE_MOVE`

#### 推しごとシート機能の追加
- **VTuber別シート自動生成**: 「所属：VTuber名」形式でシートを自動作成
- **今週分のみ表示**: 各VTuberのシートには今週のスケジュールのみ保持
- **全データ保管**: 既存の「スケジュール」シートは全データ保管用として継続使用
- **自動クリーンアップ**: 今週より前のデータは自動的に削除

#### Discord通知機能の追加
- **毎朝6時自動配信**: 今日・明日のスケジュールをDiscordに通知
- **VTuber別グループ化**: 推しごとに整理された見やすい通知
- **配信なし通知**: スケジュールがない日も通知
- **Webhook連携**: Discord Webhookで簡単セットアップ

#### Gemini 2.5 Flash へのアップグレード
- **変更内容**: 解析エンジンを Gemini 2.0 Flash から **Gemini 2.5 Flash** に変更
- **理由**: より高精度な画像解析と安定した動作を実現

#### エラーハンドリングの強化
- **リトライ機能**: ネットワークエラー発生時に最大3回まで自動リトライ（待機時間: 1秒→2秒→3秒）
- **エラーコード別対応**: 主要なAPIエラー（400, 401, 403, 429, 500, 503）に対して具体的な対処方法を表示
- **クォータエラー対応**: API無料枠超過時に分かりやすいメッセージを表示し、次回のトリガー実行時に自動リトライ
- **詳細なエラーメッセージ**: 各種エラーに対して原因と対処方法を明示
- **HTTPステータス別の案内**: 400/401/403/404/429/500/503 など主要ステータスに応じて、ユーザー向けメッセージとログの診断情報を追加

#### フォルダ名の柔軟なパース
- **区切り記号を拡張**: `：` `:` `/` `-` `｜` `・` など複数の区切りを受け付けるようになり、既存フォルダ名を変えずに運用できます
- **フォールバック動作**: 区切りが見つからない場合は所属なしとして扱い、VTuber名だけで登録します

---

## 🛠️ セットアップ（Step-by-Step）

### ステップ1: Gemini API キーの取得

1. [Google AI Studio](https://aistudio.google.com/) にアクセス
2. 「Get API Key」をクリック
3. APIキーをコピーして保存（後で使います）

> **注意**: 無料枠は1日1500リクエスト程度。超過すると課金が発生する可能性があります。

---

### ステップ2: Googleドライブにフォルダを作成

1. Googleドライブに以下の2つのフォルダを作成：
   - `推しスケ_入力` （スケジュール画像をアップロードするフォルダ）
   - `推しスケ_完了` （処理済み画像が移動されるフォルダ）

2. 各フォルダ内に、VTuberごとのサブフォルダを作成：
   - フォルダ名の形式: `所属：VTuber名` をベースに、`：` `:` `/` `-` `｜` `・` など複数の区切り文字をサポート
   - 例: `個人勢：架空ほたる`、`にじさんじ-夢乃かなで`、`ホロライブ/桜庭りの`
   - 区切りを省略した場合は「所属なし」として扱います

3. フォルダIDをメモ：
   - フォルダを開いてURLを確認
   - `https://drive.google.com/drive/folders/【ここがフォルダID】`

---

### ステップ3: Googleスプレッドシートを作成

1. 新しいGoogleスプレッドシートを作成
2. スプレッドシートIDをメモ：
   - URLの`/d/【ここがスプレッドシートID】/edit`部分

---

### ステップ4: Googleカレンダーを作成（任意）

1. Googleカレンダーで新しいカレンダーを作成（推奨）
2. カレンダーIDをメモ：
   - カレンダー設定 → 「カレンダーの統合」
   - カレンダーIDをコピー（例: `xxxx@group.calendar.google.com`）

---

### ステップ5: GASプロジェクトを作成

1. [Google Apps Script](https://script.google.com/) にアクセス
2. 「新しいプロジェクト」をクリック
3. プロジェクト名を「推しスケ」に変更
4. `code.gs` の内容を全て削除
5. [src/code.gs](src/code.gs) の内容をコピー＆ペースト
6. 保存（💾アイコンをクリック）

---

### ステップ6: スクリプトプロパティを設定

1. GASエディタで「プロジェクトの設定（⚙アイコン）」をクリック
2. 「スクリプトプロパティ」セクションまでスクロール
3. 「プロパティを追加」で以下を設定：

| プロパティ名 | 説明 | 取得方法 | 例 | 必須 |
|-------------|------|----------|-----|------|
| `GEMINI_API_KEY` | Gemini APIキー | Google AI Studio | `AIza...` | ✅ |
| `INPUT_FOLDER_ID` | 入力フォルダID | DriveのURL | `173ibp...` | ✅ |
| `DONE_FOLDER_ID` | 処理済みフォルダID | DriveのURL | `18I6b...` | ✅ |
| `SPREADSHEET_ID` | スプレッドシートID | スプシのURL | `1rWFI...` | ✅ |
| `SHEET_NAME` | シート名 | 任意 | `スケジュール` | ⚪ |
| `CALENDAR_ID` | カレンダーID | カレンダー設定 | `xxxx@group.calendar.google.com` | ✅ |
| `DISCORD_WEBHOOK_URL` | Discord Webhook URL | Discord設定 | `https://discord.com/api/webhooks/...` | ⚪ |
| `DRY_RUN` | ドライランモード（全体） | `true` または `false` | `true` | ⚪ |
| `DRY_RUN_SPREADSHEET` | スプレッドシート書き込みのドライラン | `true` または `false` | 未設定時は`DRY_RUN`の値 | ⚪ |
| `DRY_RUN_CALENDAR` | カレンダー登録のドライラン | `true` または `false` | 未設定時は`DRY_RUN`の値 | ⚪ |
| `DRY_RUN_DISCORD` | Discord通知のドライラン | `true` または `false` | 未設定時は`DRY_RUN`の値 | ⚪ |
| `DRY_RUN_FILE_MOVE` | ファイル移動のドライラン | `true` または `false` | 未設定時は`DRY_RUN`の値 | ⚪ |
| `TEST_MODE` | テスト環境モード | `true` または `false` | `false` | ⚪ |
| `TEST_INPUT_FOLDER_ID` | テスト用入力フォルダID | DriveのURL | テスト環境用 | ⚪ |
| `TEST_DONE_FOLDER_ID` | テスト用処理済みフォルダID | DriveのURL | テスト環境用 | ⚪ |
| `TEST_SPREADSHEET_ID` | テスト用スプレッドシートID | スプシのURL | テスト環境用 | ⚪ |
| `TEST_CALENDAR_ID` | テスト用カレンダーID | カレンダー設定 | テスト環境用 | ⚪ |
| `TEST_DISCORD_WEBHOOK_URL` | テスト用Discord Webhook URL | Discord設定 | テスト環境用 | ⚪ |

> **重要**: 初回は必ず `DRY_RUN` を `true` に設定してテストしてください！
>
> **ドライランの細分化**: 個別の処理だけドライランにすることもできます。
> - 例: `DRY_RUN=false`, `DRY_RUN_DISCORD=true` → Discord通知だけスキップ
> - 未設定の場合は `DRY_RUN` の値が適用されます
>
> **Discord通知**: `DISCORD_WEBHOOK_URL` を設定すると毎朝6時に今日・明日のスケジュールが配信されます（任意）

---

### ステップ7: 初回テスト実行

1. GASエディタで「実行」→「testProcessImages」を選択
2. 初回は権限の承認を求められます：
   - 「権限を確認」をクリック
   - 自分のGoogleアカウントを選択
   - 「詳細」→「推しスケ（安全ではないページ）に移動」
   - 「許可」をクリック
3. 実行ログを確認（「実行数」→「最新の実行」で確認）

**ドライランモード**では、画像解析のみ実行され、実際の書き込み・移動は行われません。

---

### ステップ8: トリガー設定（定期実行）

テストが成功したら、定期実行を設定しましょう。

1. GASエディタで「トリガー（⏰アイコン）」をクリック
2. 「トリガーを追加」をクリック
3. 以下のように設定：
   - 実行する関数: `processNewImages`
   - 実行するデプロイ: `Head`
   - イベントのソース: `時間主導型`
   - 時間ベースのトリガー: `時間ベースのタイマー`
   - 時間の間隔: `1時間ごと`（お好みで調整）
4. 「保存」をクリック

---

### ステップ9: Discord通知の設定（任意）

毎朝6時に今日・明日のスケジュールをDiscordに通知したい場合は、以下の設定を行います。

#### Discord Webhookの作成

1. **Discordサーバーで操作**
   - サーバー設定 → 連携サービス → ウェブフック
   - 「新しいウェブフック」をクリック
   - 名前を「推しスケBot」などに設定
   - 投稿先チャンネルを選択
   - 「ウェブフックURLをコピー」

2. **GASで設定**
   - スクリプトプロパティに `DISCORD_WEBHOOK_URL` を追加
   - 値にコピーしたWebhook URLを貼り付け

3. **トリガー設定**
   - GASエディタ → トリガー → 追加
   - 実行する関数: `sendDailyScheduleToDiscord`
   - イベントソース: 時間主導型
   - 時間ベースのトリガー: 日タイマー
   - 時刻: 午前6時～7時
   - 「保存」をクリック

4. **動作確認**
   - GASエディタで「実行」→「sendDailyScheduleToDiscord」を選択
   - Discordチャンネルにメッセージが届くことを確認

---

### ステップ10: 本番実行

ドライランでの動作確認が完了したら、本番モードに切り替えます。

1. スクリプトプロパティの `DRY_RUN` を `false` に変更
2. 再度テスト実行して、実際に書き込みが行われることを確認

---

## 📋 使い方

1. **スケジュール画像を準備**
   - VTuberが公開している配信スケジュール画像を保存

2. **Googleドライブにアップロード**
   - `推しスケ_入力/所属：VTuber名/` フォルダに画像をアップロード

3. **自動処理を待つ**
   - トリガー設定した時間間隔で自動的に処理されます
   - すぐに反映させたい場合は、GASエディタで手動実行：
     - 「実行」→「processNewImages」を選択
     - 実行ログで処理結果を確認
   - 処理が完了すると：
     - スプレッドシートにスケジュールが追加
     - カレンダーに予定が登録
     - 画像が `推しスケ_完了/所属：VTuber名/` に移動

4. **確認**
   - スプレッドシートやカレンダーで予定を確認
   - GoogleCalendarと連携済みのClaude（MCP連携）なら「今日の配信予定は？」と聞けば回答してくれます

---

## 🎨 画像フォーマットの推奨

Gemini AIの解析精度を上げるために、以下のような画像が適しています：

### ✅ 推奨
- 横書きのスケジュール画像
- シンプルなレイアウト
- 文字サイズがある程度大きいもの
- 背景と文字のコントラストが高いもの

### ⚠️ 精度が下がる可能性
- 縦書き
- 装飾過多
- 手書き風フォント
- 文字が小さすぎる
- 画像が不鮮明

**実績**: 10人以上のVTuberスケジュール画像でテスト済み、相違なしでした。

---

## 📊 動作フロー

```
[手動] Driveの「入力フォルダ/所属：VTuber名/」に画像を入れる
    ↓
[自動] GASが定期実行（トリガー設定）
    ↓
[自動] Gemini 2.5 Flashで画像解析 → スケジュールJSON抽出
    ↓
[自動] Googleスプレッドシートに書き込み
    ├─ 全データ保管用「スケジュール」シート
    └─ VTuber別シート（今週分のみ）
    ↓
[自動] Googleカレンダーに予定登録
    ↓
[自動] 処理済み画像を「完了フォルダ/所属：VTuber名/」に移動
    ↓
[自動] 毎朝6時 → Discordに今日・明日のスケジュール通知（任意）
    ↓
[手動] ClaudeのMCP連携で「今日の配信予定は？」と聞けば回答
```

---

## 💰 Gemini API 無料枠について

**無料枠**:
- 1分あたり15リクエスト
- 1日あたり約1500リクエスト

**注意事項**:
- 無料枠を超過すると課金が発生する可能性があります
- 大量の画像を一度に処理する場合は注意してください
- 詳細は [Google AI Studio の料金](https://ai.google.dev/pricing) を確認してください

---

## 🔒 安全に使うための権限・理由・懸念

このツールが必要とする権限と、その理由を説明します。

### 必要な権限

| 権限 | 理由 |
|------|------|
| Googleドライブへのアクセス | スケジュール画像の読み込み・移動のため |
| Googleスプレッドシートへのアクセス | スケジュールデータの書き込みのため |
| Googleカレンダーへのアクセス | 配信予定の登録のため |
| 外部サービスへの接続 | Gemini APIへのリクエスト送信のため |

### セキュリティ上の注意

- ⚠️ **APIキーは絶対に公開しないでください**
- ⚠️ GASのスクリプトプロパティに保存することで、コード内にAPIキーを直接書かずに済みます
- ⚠️ 他人と共有する場合は、自分のAPIキーを削除してから共有してください

---

## ❓ FAQ / 既知の制限

### Q: 年またぎのスケジュールは正しく処理される？

**A**: 基本的には対応済みです。以下のロジックで判定しています：

- 基本は現在の年とする
- 現在12月で、スケジュールに1月や2月がある場合は翌年
- 現在1月で、スケジュールに12月がある場合は前年

ただし、数ヶ月先のスケジュールは誤判定の可能性があります。

### Q: 複数の配信が同じ日にある場合は？

**A**: 別々のエントリとして登録されます。

### Q: スケジュール画像を更新したい場合は？

**A**:
1. 元の画像を削除
2. 新しい画像をアップロード
3. スプレッドシート・カレンダーの古い予定を手動で削除
4. 再度自動処理を待つ

### Q: 処理が実行されない

**A**: 以下を確認してください：
- トリガーが正しく設定されているか
- スクリプトプロパティが全て設定されているか
- 実行ログにエラーが出ていないか（GASエディタの「実行数」で確認）

### Q: エラーが出る

**A**: 実行ログを確認してください。エラーメッセージに対処方法が記載されています。

### Q: API呼び出しが失敗する

**A**: 以下の対策が実装されています：
- **リトライ機能**: ネットワークエラー時は最大3回まで自動リトライ
- **エラーコード別対応**:
  - 400: 画像データの破損チェック
  - 401: APIキーの再確認
  - 403: APIキー権限の確認
  - 429: 無料枠超過、次回自動リトライ
  - 500/503: API障害、時間をおいて再試行
- **詳細なエラーメッセージ**: 実行ログで具体的な対処方法を確認できます

### Q: VTuber別シートとは？

**A**: 各VTuber専用のシートが自動作成されます：
- シート名: 「所属：VTuber名」（例: `個人勢：星野ひかり`）
- 内容: 今週のスケジュールのみ表示
- 自動クリーンアップ: 今週より前のデータは自動削除
- 用途: 特定の推しのスケジュールを一目で確認

### Q: Discord通知が届かない

**A**: 以下を確認してください：
- `DISCORD_WEBHOOK_URL` が正しく設定されているか
- トリガーが `sendDailyScheduleToDiscord` 関数で設定されているか
- スケジュールデータがスプレッドシートに存在するか
- GASエディタで手動実行してエラーログを確認

### Q: Discord通知を停止したい

**A**: 以下のいずれかの方法で停止できます：
- トリガーを削除: GASエディタ → トリガー → 該当トリガーを削除
- Webhook URLを削除: スクリプトプロパティから `DISCORD_WEBHOOK_URL` を削除
- ドライラン設定: `DRY_RUN_DISCORD=true` でDiscord通知だけスキップ

### Q: ドライランモードの細分化とは？

**A**: 処理ごとに個別にドライランを設定できます：

**使用例：**
```
DRY_RUN=false（本番モード）
DRY_RUN_DISCORD=true（Discord通知だけドライラン）

→ スプシ・カレンダー・ファイル移動は実行、Discordだけスキップ
```

**個別フラグ：**
- `DRY_RUN_SPREADSHEET`: スプレッドシート書き込み
- `DRY_RUN_CALENDAR`: カレンダー登録
- `DRY_RUN_DISCORD`: Discord通知
- `DRY_RUN_FILE_MOVE`: ファイル移動

**デフォルト動作：**
- 個別フラグ未設定の場合は `DRY_RUN` の値を使用
- すべて未設定の場合は `DRY_RUN=true`（ドライラン）

---

## 👨‍💻 開発者向けガイド

### clasp を使った GitHub ⇄ GAS 連携

**clasp** (Command Line Apps Script Projects) を使うと、手動コピペなしで GitHub と GAS を同期できます。

#### セットアップ手順

1. **Node.js と clasp をインストール**
   ```bash
   # Node.js がインストールされていることを確認
   node --version

   # clasp をグローバルインストール
   npm install -g @google/clasp

   # Google アカウントでログイン
   clasp login
   ```

2. **プロジェクトをクローン**
   ```bash
   git clone https://github.com/YoyogiPinball/oshi-sche.git
   cd oshi-sche
   npm install
   ```

3. **GAS プロジェクトと連携**
   ```bash
   # 既存のGASプロジェクトがある場合
   # .clasp.json にスクリプトIDを設定
   # または新規作成
   clasp create --type standalone --title "oshi-sche" --rootDir ./src
   ```

4. **コードをプッシュ**
   ```bash
   # GASにプッシュ
   npm run push
   # または
   clasp push
   ```

5. **コードをプル**
   ```bash
   # GASから最新版を取得
   npm run pull
   # または
   clasp pull
   ```

#### ワークフロー例

```bash
# ローカルでコード編集
vim src/code.gs

# GitHubにプッシュ
git add .
git commit -m "機能追加"
git push origin main

# GASにもプッシュ
clasp push
```

---

### テスト環境の利用

本番環境とは別のリソース（フォルダ、スプシ、カレンダー）でテストできます。

#### 設定方法

1. **テスト用リソースを作成**
   - テスト用のドライブフォルダ
   - テスト用のスプレッドシート
   - テスト用のカレンダー
   - テスト用のDiscord Webhook（任意）

2. **スクリプトプロパティに追加**
   ```
   TEST_MODE = true
   TEST_INPUT_FOLDER_ID = (テスト用フォルダID)
   TEST_DONE_FOLDER_ID = (テスト用完了フォルダID)
   TEST_SPREADSHEET_ID = (テスト用スプシID)
   TEST_CALENDAR_ID = (テスト用カレンダーID)
   TEST_DISCORD_WEBHOOK_URL = (テスト用WebhookURL)
   ```

3. **テスト実行**
   - `TEST_MODE=true` の間、本番リソースには一切触れません
   - テストが完了したら `TEST_MODE=false` に戻す

---

### ユニットテストの実行

**test.gs** に自動テストコードが含まれています。

#### テストの実行方法

1. **GASエディタでテストを実行**
   - GASエディタを開く
   - 関数リストから `runAllTests` を選択
   - 「実行」をクリック

2. **ログで結果を確認**
   ```
   ========================================
   ユニットテスト開始
   ========================================

   テスト実行: testShouldExecute
   ✓ testShouldExecute - 成功

   テスト実行: testGetActionLabel
   ✓ testGetActionLabel - 成功

   ...

   ========================================
   テスト結果サマリー
   ========================================
   成功: 7/7
   失敗: 0/7

   🎉 すべてのテストが成功しました！
   ```

3. **個別テストの実行**
   ```javascript
   // GASエディタで実行
   runSingleTest('testShouldExecute');
   ```

#### テストの追加

`src/test.gs` に新しいテスト関数を追加し、`runAllTests()` の `tests` 配列に登録します。

```javascript
function testMyNewFeature() {
  const result = myNewFeature();
  assertEqual(result, expectedValue, 'My feature should work');
}

function runAllTests() {
  const tests = [
    // ... 既存のテスト
    testMyNewFeature  // 追加
  ];
  // ...
}
```

---

### GitHub Actions による自動チェック

Pull Request を作成すると、自動でコードチェックが実行されます。

#### チェック内容

- ✅ ファイル構造の検証
- ✅ JSON ファイルの構文チェック
- ✅ JavaScript 構文チェック
- ✅ ハードコードされた API キーの検出
- ✅ TODO コメントのカウント

#### ワークフロー

1. **ブランチを作成**
   ```bash
   git checkout -b feature/new-feature
   ```

2. **コードを編集＆コミット**
   ```bash
   git add .
   git commit -m "Add new feature"
   git push origin feature/new-feature
   ```

3. **Pull Request を作成**
   - GitHub で Pull Request を作成
   - 自動的に GitHub Actions が実行される
   - チェックが通れば緑のチェックマーク ✓

4. **マージ**
   - チェックが成功したらマージ
   - 失敗した場合はエラーメッセージを確認して修正

---

## 🛡️ 免責事項

- ⚠️ 本ツールはGemini APIを使用しています。ご利用は自己責任でお願いします。
- ⚠️ 非公式ツールです。
- ⚠️ 悪用は禁止します。
- ⚠️ 他者に迷惑をかけないようご利用ください。
- ⚠️ 個人利用の範疇でお願いします。
- ⚠️ [Gemini APIの利用規約](https://ai.google.dev/gemini-api/terms)も遵守してください。
- ⚠️ VTuberやタレントのスケジュール画像の著作権は各所属事務所・本人に帰属します。

---

## 🤝 機能の提案・バグ報告

Issue または Pull Request をお待ちしています！

- [Issue を作成](https://github.com/YoyogiPinball/oshi-sche/issues)
- [Pull Request を作成](https://github.com/YoyogiPinball/oshi-sche/pulls)

---

## 📄 ライセンス

[MIT License](LICENSE)

Copyright (c) 2025 YoyogiPinball

---

## 🚀 今後の展望

- [ ] WebUIの提供
